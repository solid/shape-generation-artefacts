@prefix sh:    <http://www.w3.org/ns/shacl#> .
@prefix dc:    <http://purl.org/dc/elements/1.1/> .
@prefix foaf:  <http://xmlns.com/foaf/0.1/> .
@prefix cal:   <http://www.w3.org/2002/12/cal/ical#> .
@prefix sched: <http://www.w3.org/ns/pim/schedule#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix ex:    <http://example.org/shapes#> .

#################################################
# Event Shape
#################################################

ex:VeventShape
    a sh:NodeShape ;
    sh:targetClass cal:Vevent ;

    # Title (required)
    sh:property [
        sh:path cal:summary ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
    ] ;

    # Location (optional)
    sh:property [
        sh:path cal:location ;
        sh:datatype xsd:string ;
    ] ;

    # Comment (optional)
    sh:property [
        sh:path cal:comment ;
        sh:datatype xsd:string ;
    ] ;

    # allDay flag (required)
    sh:property [
        sh:path sched:allDay ;
        sh:datatype xsd:boolean ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
    ] ;

    # Authors (at least 1)
    sh:property [
        sh:path dc:author ;
        sh:node ex:AuthorShape ;
        sh:minCount 1 ;
    ] ;

    # Scheduling options (at least 2)
    sh:property [
        sh:path sched:option ;
        sh:node ex:OptionShape ;
        sh:minCount 2 ;
    ] ;

    # Invitees (at least 1)
    sh:property [
        sh:path sched:invitee ;
        sh:node ex:InviteeShape ;
        sh:minCount 1 ;
    ] ;

    #################################################
    # Conditional Duration Constraint
    #################################################

    sh:or (
        # Case 1: allDay = true → durationInDays required
        [
            sh:and (
                [
                    sh:property [
                        sh:path sched:allDay ;
                        sh:hasValue true ;
                    ]
                ]
                [
                    sh:property [
                        sh:path sched:durationInDays ;
                        sh:datatype xsd:integer ;
                        sh:minInclusive 1 ;
                        sh:minCount 1 ;
                        sh:maxCount 1 ;
                    ]
                ]
            )
        ]

        # Case 2: allDay = false → durationInMinutes required
        [
            sh:and (
                [
                    sh:property [
                        sh:path sched:allDay ;
                        sh:hasValue false ;
                    ]
                ]
                [
                    sh:property [
                        sh:path sched:durationInMinutes ;
                        sh:datatype xsd:integer ;
                        sh:minInclusive 5 ;
                        sh:minCount 1 ;
                        sh:maxCount 1 ;
                    ]
                ]
            )
        ]
    ) .

#################################################
# Author Shape
#################################################

ex:AuthorShape
    a sh:NodeShape ;
    sh:property [
        sh:path foaf:name ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
    ] ;
    sh:property [
        sh:path foaf:mbox ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
    ] .

#################################################
# Invitee Shape
#################################################

ex:InviteeShape
    a sh:NodeShape ;
    sh:property [
        sh:path foaf:mbox ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
    ] .

#################################################
# Scheduling Option Shape
#################################################

ex:OptionShape
    a sh:NodeShape ;
    sh:property [
        sh:path cal:dtstart ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            [ sh:datatype xsd:date ]
            [ sh:datatype xsd:dateTime ]
        ) ;
    ] .
